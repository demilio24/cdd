<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directorio CDD</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="dir-box">
  <form id="dir-form">
    <input type="text" name="contact_id" class="dir-input" placeholder="Ingrese el ID del contacto..." required>
    <button type="submit" class="dir-button">Buscar Contacto</button>
  </form>

  <div id="dir-loading" class="dir-loading" style="display:none;">
    <div class="dir-spinner"></div>
    <p>Cargando contacto...</p>
  </div>

  <div id="dir-result" class="dir-result" style="display:none;"></div>
  
  <div id="dir-error" class="dir-error" style="display:none;"></div>
</div>

<style>
  .dir-box {
    font-family: 'Poppins', sans-serif;
    background-color: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    max-width: 500px;
    margin: 0 auto;
    text-align: left;
  }

  .dir-input {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 16px;
    margin-bottom: 1rem;
    background-image: url('https://img.icons8.com/ios-glyphs/30/000000/search--v1.png');
    background-repeat: no-repeat;
    background-position: 10px center;
    padding-left: 40px;
    box-sizing: border-box;
  }

  .dir-button {
    background-color: #155eef;
    color: white;
    border: none;
    padding: 12px;
    width: 100%;
    font-size: 16px;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  
  .dir-button:hover {
    background-color: #0f4bdb;
  }
  
  .dir-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  .dir-loading {
    margin-top: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
  }

  .dir-spinner {
    border: 5px solid #e3e3e3;
    border-top: 5px solid #155eef;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: dir-spin 1s linear infinite;
  }

  @keyframes dir-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .dir-result {
    margin-top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .dir-field {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    padding-bottom: 8px;
  }

  .dir-label {
    font-weight: 600;
    color: #333;
  }

  .dir-value {
    color: #444;
    text-align: right;
  }

  .dir-risk {
    font-weight: bold;
    padding: 8px 12px;
    border-radius: 6px;
    display: inline-block;
    margin-top: 10px;
  }

  .dir-bajo { background-color: #d4edda; color: #155724; }
  .dir-medio { background-color: #fff3cd; color: #856404; }
  .dir-alto { background-color: #f8d7da; color: #721c24; }
  .dir-sin { background-color: #e2e3e5; color: #6c757d; }

  .dir-custom-fields {
    margin-top: 20px;
    padding: 0;
    border: none;
  }

  .dir-custom-fields-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 16px;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .dir-custom-field {
    background-color: #f8f9fa;
    padding: 10.8px 14.4px;
    border-radius: 8px;
    margin-bottom: 10.8px;
    border: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .dir-custom-field-name {
    font-weight: 500;
    color: #495057;
    font-size: 14px;
    flex: 1;
  }

  .dir-custom-field-value {
    font-weight: 600;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
    text-transform: uppercase;
  }

  .dir-custom-field-value.bajo {
    background-color: #d4edda;
    color: #155724;
  }

  .dir-custom-field-value.medio {
    background-color: #fff3cd;
    color: #856404;
  }

  .dir-custom-field-value.alto {
    background-color: #f8d7da;
    color: #721c24;
  }

  .dir-custom-field-value.sin {
    background-color: #e2e3e5;
    color: #6c757d;
  }
  
  .dir-error {
    margin-top: 1.5rem;
    padding: 12px;
    background-color: #f8d7da;
    color: #721c24;
    border-radius: 8px;
    border: 1px solid #f5c6cb;
  }
  
  .dir-no-data {
    color: #6c757d;
    font-style: italic;
  }
</style>

<script>
  const form = document.getElementById('dir-form');
  const loading = document.getElementById('dir-loading');
  const result = document.getElementById('dir-result');
  const errorDiv = document.getElementById('dir-error');
  const submitButton = form.querySelector('.dir-button');

  // Sanitize input to prevent XSS
  function sanitizeHtml(str) {
    const temp = document.createElement('div');
    temp.textContent = str;
    return temp.innerHTML;
  }

  function formatRiskValue(value) {
  if (!value || value === null || value === undefined || value === '') {
    return { text: 'Sin procesar', class: 'dir-sin' };
  }
  const normalizedValue = String(value).toLowerCase().trim();
  switch(normalizedValue) {
    case 'bajo':
      return { text: 'Bajo', class: 'dir-bajo' };
    case 'medio':
      return { text: 'Medio', class: 'dir-medio' };
    case 'alto':
      return { text: 'Alto', class: 'dir-alto' };
    default:
      return { text: 'Sin procesar', class: 'dir-sin' };
  }
}


  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Reset displays
    result.style.display = 'none';
    errorDiv.style.display = 'none';
    loading.style.display = 'flex';
    
    // Disable submit button
    submitButton.disabled = true;

    const contactId = e.target.contact_id.value.trim();
    console.log("üîç ID ingresado:", contactId);

    try {
      console.log("üì§ Enviando petici√≥n con:", { contact_id: contactId });
      
      const res = await fetch('https://nilsdigital.app.n8n.cloud/webhook/cdd', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ contact_id: contactId })
      });

      console.log("üì° Estado de respuesta:", res.status);

      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }

      const raw = await res.json();
      console.log("üì¶ Respuesta cruda:", raw);

      const data = Array.isArray(raw) ? raw[0] : raw;
      console.log("‚úÖ Objeto procesado:", data);

      // Check for error in response
      if (data?.error) {
        throw new Error(data.error);
      }

      const name = data?.name || 'Sin nombre';
      const id = data?.id;
      const risk = data?.risk;
      const country = data?.country || null;
      const flagUrl = data?.country_flag_url || null;
      const customFields = data?.custom_fields || [];

      if (!id || id === "N/A") {
        errorDiv.innerHTML = `‚ùå No encontramos a nadie con ese ID. Aseg√∫rate de que est√© correctamente escrito.`;
        errorDiv.style.display = 'block';
      } else {
        // Format risk
        const riskFormatted = formatRiskValue(risk);

        // Generate HTML for custom fields
        let customFieldsHtml = '';
        let hasValidCustomFields = false;
        
        if (customFields && customFields.length > 0) {
          // Check if any custom field has a valid risk value
          hasValidCustomFields = customFields.some(field => 
            field.value && ['bajo', 'medio', 'alto'].includes(String(field.value).toLowerCase().trim())
          );
          
          if (hasValidCustomFields || customFields.length > 0) {
            customFieldsHtml = `
              <div class="dir-custom-fields">
                <div class="dir-custom-fields-title">üìä Perfil De Riesgo Por Segmento De Negocio</div>
                ${customFields.map(field => {
                  const fieldRisk = formatRiskValue(field.value);
                  return `
                    <div class="dir-custom-field">
                      <div class="dir-custom-field-name">${sanitizeHtml(field.name)}</div>
                      <div class="dir-custom-field-value ${fieldRisk.class}">${fieldRisk.text}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            `;
          }
        }

        result.innerHTML = `
 <div class="dir-field">
    <span class="dir-label">üë§ Nombre:</span> 
    <span class="dir-value">${sanitizeHtml(name)}</span>
  </div>
  <div class="dir-field">
    <span class="dir-label">üÜî ID:</span> 
    <span class="dir-value">${sanitizeHtml(id)}</span>
  </div>
  <div class="dir-field">
    <span class="dir-label">üåç Pa√≠s:</span>
    <span class="dir-value">
      ${country ? `${sanitizeHtml(country)} <img src="${flagUrl}" alt="${sanitizeHtml(country)}" style="height: 18px; vertical-align: middle; margin-left: 6px;" onerror="this.style.display='none'">` : `<span class="dir-no-data">No especificado</span>`}
    </span>
  </div>
  ${(!hasValidCustomFields && risk) ? `
    <div class="dir-field">
      <span class="dir-label">‚ö†Ô∏è Riesgo General:</span>
      <span class="dir-value dir-risk ${riskFormatted.class}">${riskFormatted.text}</span>
    </div>
  ` : ''}
  ${customFieldsHtml}
`;

        
        result.style.display = 'block';
      }

    } catch (err) {
      console.error("‚ùå Error completo:", err);
      
      let errorMessage = "‚ùå ";
      
      if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
        errorMessage += "Error de conexi√≥n. Por favor, verifica tu conexi√≥n a internet e intenta nuevamente.";
      } else if (err.message.includes('404')) {
        errorMessage += "No encontramos a nadie con ese ID. Aseg√∫rate de que est√© correctamente escrito.";
      } else if (err.message.includes('500')) {
        errorMessage += "No encontramos a nadie con ese ID. Aseg√∫rate de que est√© correctamente escrito.";
      } else {
        errorMessage += err.message || "Ocurri√≥ un error inesperado. Por favor, intenta nuevamente.";
      }
      
      errorDiv.innerHTML = errorMessage;
      errorDiv.style.display = 'block';
    } finally {
      loading.style.display = 'none';
      submitButton.disabled = false;
    }
  });

  // Auto-fill from URL parameter
  document.addEventListener('DOMContentLoaded', () => {
    console.log("üîÑ DOM loaded, checking URL...");
    const search = window.location.search;
    console.log("üåê URL search:", search);
    
    let contactId = null;
    
    // Check for named parameters first (?id=xxx or ?contact_id=xxx)
    const urlParams = new URLSearchParams(search);
    contactId = urlParams.get('id') || urlParams.get('contact_id');
    
    // If no named parameter, check for direct parameter (?xxx)
    if (!contactId && search.startsWith('?')) {
      const rawParam = search.slice(1).split('&')[0]; // Get first param only
      // Validate it's a valid contact ID format
      if (rawParam && /^[a-zA-Z0-9_-]+$/.test(rawParam)) {
        contactId = rawParam;
      }
    }
    
    console.log("üÜî Contact ID found:", contactId);
    
    if (contactId) {
      const input = document.querySelector('input[name="contact_id"]');
      if (input) {
        input.value = contactId;
        console.log("‚úÖ Input filled with:", contactId);
        // Use setTimeout to ensure form is ready
        setTimeout(() => {
          console.log("üöÄ Submitting form automatically...");
          const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
          form.dispatchEvent(submitEvent);
        }, 200);
      }
    }
  });
</script>
</body>
</html>
